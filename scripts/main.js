(()=>{"use strict";var e={d:(t,n)=>{for(var i in n)e.o(n,i)&&!e.o(t,i)&&Object.defineProperty(t,i,{enumerable:!0,get:n[i]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)};e.d({},{a:()=>w});let t="",n="module";function i(...e){return`${t}.settings.${e.join(".")}`}function o(...e){return e=e.filter((e=>"string"==typeof e)),`${n}s/${t}/templates/${e.join("/")}`}function s(e){return game.settings.get(t,e)}function a(e,n){return game.settings.set(t,e,n)}function r(e){const n=e.name;e.scope=e.scope??"world",e.config=e.config??!1,e.config&&(e.name=i(n,"name"),e.hint=i(n,"hint")),Array.isArray(e.choices)&&(e.choices=e.choices.reduce(((e,t)=>(e[t]=i(n,"choices",t),e)),{})),game.settings.register(t,n,e)}function c(e){return game.modules.get(e)}const d="monks-tokenbar";function l(){return c(d)?.active}function h(){return"pf2e"===game.system.id&&(game.settings.settings.has("pf2e.metagame.tokenSetsNameVisibility")?!!game.settings.get("pf2e","metagame.tokenSetsNameVisibility"):!!game.settings.get("pf2e","metagame_tokenSetsNameVisibility"))}let m,u,g,f;function p(...e){let[n,i]=e;return n=`${t}.${n}`,i?game.i18n.format(n,i):game.i18n.localize(n)}function b(e,n,i){return e.getFlag(t,n)??i}const v="pf2e";function _(){return m?.()??!1}function C(e){return e.actor?.hasPlayerOwner||(u?.(e)??!0)}function y(e){return g?.(e)}function H(e){return f?.(e)??p("unknown")}function k(e){const t=function(e){if(game.system.id===v)return function(e){const t=e.actor;if(!t)return CONFIG.Canvas.dispositionColors.NEUTRAL;const n=t.alliance;return"party"===n?t.hasPlayerOwner?CONFIG.Canvas.dispositionColors.PARTY:CONFIG.Canvas.dispositionColors.FRIENDLY:"opposition"===n?CONFIG.Canvas.dispositionColors.HOSTILE:CONFIG.Canvas.dispositionColors.NEUTRAL}(e);const t=e.actor,n=e.token;if(!t||!n)return CONFIG.Canvas.dispositionColors.NEUTRAL;if(t.hasPlayerOwner)return CONFIG.Canvas.dispositionColors.PARTY;const i=n.disposition;return i===CONST.TOKEN_DISPOSITIONS.FRIENDLY?CONFIG.Canvas.dispositionColors.FRIENDLY:i===CONST.TOKEN_DISPOSITIONS.HOSTILE?CONFIG.Canvas.dispositionColors.HOSTILE:CONFIG.Canvas.dispositionColors.NEUTRAL}(e);return new Color(t)}class MiniTracker extends Application{_isExpanded;_maxHeight;_dragging;_lastCombat;_lastCombatant;_lastMoveTime;_initialPosition;_initialPointer={x:0,y:0};_combatantHeight;_boxHeight;_innerMargins;_isReversed;_dragHook;_dragEndHook;_expandedDebounce;_coordsDebounce;_menu;_listHoverHook;_resizeHook;_resizeEndHook;_sortable;_hooks;_lastTurn;constructor(){super();const{left:e,bottom:t,top:n}=s("coords");"number"==typeof e&&(this.position.left=e),"number"==typeof n&&(this.position.top=n),"number"==typeof t&&(this.position.bottom=t);const i=s("expanded");this._isExpanded="false"!==i,this._maxHeight="false"!==i&&"true"!==i?parseInt(i):void 0,this._isReversed=s("reversed"),this._dragging=!1,this._lastCombat="",this._lastCombatant="",this._lastTurn=-1,this._lastMoveTime=0,this._dragHook=this.#e.bind(this),this._dragEndHook=this.#t.bind(this),this._resizeHook=this.#n.bind(this),this._resizeEndHook=this.#i.bind(this),this._hooks=[Hooks.on("renderCombatTracker",(()=>this.render())),Hooks.on("hoverToken",this.#o.bind(this)),Hooks.on("preCreateCombatant",this.#s.bind(this)),Hooks.on("targetToken",this.#a.bind(this))],this._coordsDebounce=debounce(this.#r,1e3),this._expandedDebounce=debounce(this.#c,1e3),this._initialPosition=this.position}static get defaultOptions(){return{...super.defaultOptions,popOut:!1,minimizable:!1,template:o("tracker.hbs")}}get isReversed(){return this._isReversed}set isReversed(e){this._isReversed=e,this.render(),a("reversed",e)}get isExpanded(){return this._isExpanded}set isExpanded(e){this._isExpanded=e,e?this.#d():this.#l(),this.#c()}get isDragging(){return this._dragging}set isDragging(e){this.element.toggleClass("dragging",e),this._dragging=e}get moveTick(){const e=Date.now();return!(e-this._lastMoveTime<1e3/60||(this._lastMoveTime=e,0))}get innerElement(){return this.element.find(".__inner")}get combatantElements(){return this.element.find(".combatant")}get listElement(){return this.element.find(".__inner > ol")}get combatantHeight(){return this._combatantHeight||(this._combatantHeight=this.combatantElements.filter(".active").outerHeight(!0)),this._combatantHeight}get boxHeight(){if(this._boxHeight)return this._boxHeight;const e=this.element.outerHeight(!0),t=this.listElement.innerHeight();return this._boxHeight=e-t,this._boxHeight}get innerMargins(){if(this._innerMargins)return this._innerMargins;const e=this.innerElement;return this._innerMargins=parseInt(e.css("margin-top"))+parseInt(e.css("margin-bottom")),this._innerMargins}get minHeight(){return this.combatantHeight+this.boxHeight}get maxHeight(){return this._maxHeight}set maxHeight(e){this._maxHeight=e,this._expandedDebounce()}async getData(e){const t=ui.combat.viewed;if(!t||!t.turns.some((e=>e.isOwner)))return{hasCombat:!1};const n=game.user.isGM,i=t.combatant,o=s("showHp"),a=s("hpValue"),r=s("hpMax"),c=s("turn"),d=this.isReversed,h=_(),m=s("immobilize")&&!l(),u=canvas.scene?.id,g=game.user.hasPermission("PING_CANVAS"),f=s("dead")&&game.settings.get("core","combatTrackerConfig").skipDefeated,p=s("dim");let v=!1,y=!1;const E=[];for(const[e,s]of t.turns.entries()){if(!s.visible)continue;if(f&&s.defeated&&!s.actor?.hasPlayerOwner)continue;let c=s.isDefeated;const d=new Map;if(s.actor)for(const e of s.actor.temporaryEffects)e.getFlag("core","statusId")===CONFIG.specialStatusEffects.DEFEATED?c=!0:e.icon&&d.set(e.icon,{icon:e.icon,name:e.label});const l=a?getProperty(s,`actor.system.${a}`):void 0,_=r?getProperty(s,`actor.system.${r}`):void 0;let w;void 0!==l&&void 0!==_&&(w=122*((x=l/_)*x)+3);const T=s.initiative,O=null!==T;O&&!Number.isInteger(T)&&(y=!0);const I=e===t.turn;I&&(v=!0);let D=s.name;const N=C(s),S=s.hidden,M=!!s.actor?.hasPlayerOwner,P=[];I&&P.push("active"),S&&P.push("hidden"),c&&P.push("defeated"),h&&!N&&(n?p&&P.push("anonymous"):D=H(s));const L=k(s),R={combatantId:s.id,tokenId:s.tokenId,css:P.join(" "),colors:{border:L.css,background:L.toRGBA(.1)},name:D,img:await ui.combat._getCombatantThumbnail(s),hidden:S,hasPlayerOwner:M,playersCanSeeName:N,freed:!m||s===i||!!b(s,"freed"),canImmobilize:s!==i,defeated:c,canPing:g&&s.sceneId===u,effects:Array.from(d.values()),hasRolled:O,initiative:T,owner:s.isOwner,hpValue:l,hpMax:_,hpHue:w,active:I,showHp:void 0!==l&&"none"!==o&&(n||"all"===o||"friendly"===o&&M)};E.push(R)}var x;if(!E.some((e=>e.owner)))return{hasCombat:!1};if(!v){const e=E[Math.min(t.turn??0,E.length-1)];e.active=!0;const n=e.css?e.css.split(" "):[];n.push("active"),e.css=n.join(" ")}const w=[];this.isExpanded&&w.push("expanded"),d&&!s("fake-reversed")&&w.push("reversed");const T=CONFIG.Combat.initiative.decimals;return E.forEach((e=>{null!==e.initiative&&(e.initiative=e.initiative.toFixed(y?T:0))})),{isGM:n,turns:E,endTurn:c,hideNames:h,immobilize:m,showHp:"all"===o||"friendly"===o||"gm"===o&&n,hasCombat:!0,round:t.round,arrow:d?"up":"down",innerCss:w.join(" "),isCurrentTurn:i?.isOwner,fontSize:s("scale")}}#a(){const e=ui.combat.viewed;if(!e)return;const t=game.user.targets.ids;this.element.find(".__inner ol li.combatant").each((function(){const{tokenId:n,combatantId:i}=this.dataset;this.querySelector('.__details .__icons [data-control="targetCombatant"]').classList.toggle("active",t.includes(n));const o=e.combatants.get(i);if(!o)return;const s=this.querySelector(".__targets");s.innerHTML="";const a=o.token?.object?.targeted.toObject().map((e=>e.color))??[];for(const e of a){const t=`<div class="target" style="background-color: ${e};"></div>`;s.insertAdjacentHTML("beforeend",t)}}))}async _render(e,t){var n;await super._render(e,t),this.#a(),game.user.isGM&&l()&&game.settings.get(d,"show-on-tracker")&&(n=this.listElement,ui.combat.element.find("#combat-tracker").find('.combatant:has([data-control="toggleMovement"])').each((function(){const e=$(this),t=e.attr("data-combatant-id"),i=e.find('[data-control="toggleMovement"]'),o=i.clone(!0);o.on("click",(()=>i.toggleClass("active"))),i.on("click",(()=>o.toggleClass("active"))),n.find(`[data-combatant-id="${t}"] [data-control="toggleDefeated"]`).before(o)})))}render(e,n){const i=ui.combat.viewed,o=game.user.isGM,a=i?.id??"",r=i?.combatant,c=s("immobilize")&&!l(),d=s("reveal"),h=s("revealToken"),m=this._lastCombatant!==r?.id,u=i?.turn!==this._lastTurn;if(o&&this._lastCombat===a&&r&&m&&u){const e=r?.token;if(e&&s("pan")&&r.visible&&canvas.animatePan({x:e.x,y:e.y}),r&&!r.actor?.hasPlayerOwner){e?.object&&s("select")&&e.object.control({releaseOthers:!0});const t=r.actor?.sheet;t&&s("sheet")&&t.render(!0)}}if(o&&i&&(this._lastCombat!==a||r&&m&&u)&&(c||d)){const e=`flags.${t}.${["freed"].join("/")}`,n=i.turns.reduce(((t,n,o)=>{let s=!1;const a={_id:n.id};return d&&o===i.turn&&n.hidden&&(h&&n.token?.update({hidden:!1}),a.hidden=!1,s=!0),c&&b(n,"freed")&&(a[e]=!1,s=!0),s&&t.push(a),t}),[]);n.length&&i.updateEmbeddedDocuments("Combatant",n)}return this._lastCombat=a,this._lastCombatant=r?.id??"",this._lastTurn=i?.turn??-1,super.render(e,n)}async close(e){const t=await super.close(e);return this._hooks.forEach((e=>Hooks.off("any",e))),t}activateListeners(e){if(!ui.combat.viewed||!this.innerElement.length)return;const t=ui.combat;e.find(".draggable").on("mousedown",this.#h.bind(this)),e.find(".__resizer").on("mousedown",this.#m.bind(this));const n=e.find(".__inner > ol");n.on("mouseenter",this.#u.bind(this)),e.on("mouseleave",this.#g.bind(this)),e.find("[data-control=trackerReverse]").on("click",(()=>this.isReversed=!this.isReversed)),e.find("[data-control=trackerExpand]").on("click",(()=>this.isExpanded=!this.isExpanded)),e.find("[data-control=targetCombatant]").on("click",this.#f.bind(this)),e.find(".combat-control").on("click",t._onCombatControl.bind(t)),e.find(".combatant-control").on("click",t._onCombatantControl.bind(t));const i=n.find(".combatant");i.on("mouseenter",t._onCombatantHoverIn.bind(t)),i.on("mouseleave",t._onCombatantHoverOut.bind(t)),game.user.isGM&&(this._contextMenu(e),this.#p(),e.find("[data-control=trackerSettings]").on("click",(()=>(new CombatTrackerConfig).render(!0))),l()||e.find('[data-control="toggleImmobilized"]').on("click",this.#b.bind(this)),_()&&g&&e.find("[data-control=toggle-name-visibility]").on("click",this.#v.bind(this)),i.on("click",t._onCombatantMouseDown.bind(t)))}setPosition({left:e,top:t,bottom:n}){const i=this.element[0],o=this.position,s=this.minHeight,a=i.offsetHeight,r=i.offsetWidth,c=window.innerHeight,d=window.innerWidth;e=e??d/2-r/2,t=t??c/2-a/2,n=n??c/2-a/2;const l=Math.max(d-r,0);return o.left=Math.clamped(e,0,l),i.style.left=o.left+"px",this.isReversed?(n+s>c&&(n=c-s),n<0&&(n=0),i.style.bottom=n+"px",o.bottom=n,o.top=c-n-s):(t+s>c&&(t=c-s),t<0&&(t=0),i.style.top=t+"px",o.top=t,o.bottom=c-t-s),this.#_(),o}_contextMenu(e){this._menu=ContextMenu.create(this,e,".combatant",ui.combat._getEntryContextOptions())}#s(e,t,n){n.temporary||!s("hide")||e.actor?.hasPlayerOwner||e.updateSource({hidden:!0})}#C(e){const t=$(e.currentTarget).closest(".combatant").attr("data-combatant-id");return ui.combat.viewed?.combatants.get(t)}#f(e){e.preventDefault();const t=this.#C(e),n=t?.token?.object;if(!n)return;const i=game.user,o=n.targeted.some((e=>e===i));n.setTarget(!o,{releaseOthers:!e.shiftKey})}#b(e){e.preventDefault();const n=this.#C(e);n&&function(e){var n;n=!b(e,"freed"),e.setFlag(t,"freed",n)}(n)}async#v(e){e.preventDefault();const t=this.#C(e);t&&(e.shiftKey&&t.actor&&t.actor.isToken&&game.combat?.scene?function(e){return e.combat.turns.filter((t=>t.actorId===e.actorId))}(t).forEach(y):y(t))}#p(){game.modules.get("_sortablejs")?.active&&(this._sortable=new Sortable(this.listElement[0],{animation:150,draggable:".combatant",delay:50,onEnd:this.#y.bind(this)}))}#y(e){const t=e.item.dataset.combatantId,n=ui.combat.viewed,i=e.oldIndex,o=e.newIndex;if(!n||i===o||!t)return;const s=n.turns;if(s.length<=1)return;const a=s.filter((e=>e.id!==t)),r=a.slice(0,o),c=a.slice(o);let d=r.reverse().find((e=>null!=e.initiative))?.initiative,l=c.find((e=>null!=e.initiative))?.initiative;null==l&&null==d?(l=0,d=2):null==l?l=d-2:null==d&&(d=l+2);const h=(d+l)/2;n.setInitiative(t,h)}#m(e){e.preventDefault(),window.addEventListener("mousemove",this._resizeHook),window.addEventListener("mouseup",this._resizeEndHook)}#n(e){if(e.preventDefault(),!this.moveTick)return;let t=e.clientY-(this.position.top??0);this.isReversed&&(t=-(t-this.minHeight)),t=Math.max(t,this.minHeight),this.#_(t),t>=this.combatantElements.length*this.combatantHeight+this.boxHeight&&(t=void 0),this.maxHeight=t}#i(e){e.preventDefault(),window.removeEventListener("mousemove",this._resizeHook),window.removeEventListener("mouseup",this._resizeEndHook)}#h(e){e.preventDefault(),this.isDragging=!0,this._initialPosition=duplicate(this.position),this._initialPointer={x:e.clientX,y:e.clientY},window.addEventListener("mousemove",this._dragHook),window.addEventListener("mouseup",this._dragEndHook)}#e(e){if(e.preventDefault(),!this.moveTick)return;const t=this._initialPosition,n=this._initialPointer,i=(t.left??0)+(e.clientX-n.x);this.isReversed?this.setPosition({left:i,bottom:(t.bottom??0)-(e.clientY-n.y)}):this.setPosition({left:i,top:(t.top??0)+(e.clientY-n.y)}),this._coordsDebounce()}#t(e){e.preventDefault(),this.isDragging=!1,this.#_(),window.removeEventListener("mousemove",this._dragHook),window.removeEventListener("mouseup",this._dragEndHook)}#o(e,t){const n=e.combatant;if(!n)return;const i=this.combatantElements;i.removeClass("hovered"),t&&i.filter(`[data-combatant-id="${n.id}"]`).addClass("hovered")}#c(){a("expanded",this.isExpanded?this.maxHeight||"true":"false")}#d(){this.innerElement.addClass("expanded"),this.#_()}#l(){this._listHoverHook&&clearTimeout(this._listHoverHook),this.innerElement.removeClass("expanded"),this._menu?.close({animate:!1})}#u(){if(this.isExpanded||!s("hover"))return;const e=s("delay");e?this._listHoverHook=setTimeout((()=>this.#d()),e):this.#d()}#g(){this.isExpanded||this.#l()}#_(e){const t=this.innerElement;if(!t.length)return;const n=window.innerHeight;let i;i=this.isReversed?n-(this.position.bottom??0):n-(this.position.top??0),e&&e<i?i=e:this.maxHeight&&this.maxHeight<i&&(i=this.maxHeight),i=Math.max(i,this.minHeight),i-=this.innerMargins,t.css("max-height",i),this.isExpanded&&this.#H()}#H(){const e=this.listElement,t=e.innerHeight();if(t===e.prop("scrollHeight"))return;const n=e.find("> .active")[0];e.scrollTop(n.offsetTop-t/2+n.offsetHeight/2)}#r(){const{left:e,top:t,bottom:n}=this.position;a("coords",{left:e,top:t,bottom:n})}}function E(e,t,n,i){const o="string"==typeof t?t:"info",s="object"==typeof t?t:"object"==typeof n?n:void 0,a="boolean"==typeof t?t:"boolean"==typeof n?n:i??!1;ui.notifications.notify(p(e,s),o,{permanent:a})}function x(e,t){if(!w||!("x"in t)&&!("y"in t))return;const n=e.combatant,i=ui.combat.viewed;i&&n&&i.combatant!==n&&!b(n,"freed")&&(delete t.x,delete t.y,function(...e){const[t,n,i]=e;E(t,"warning",n,i)}("immobilized"))}!function(e,i=!1){t||(t="mini-tracker"),n=i?"system":"module"}();let w=null;function T(e){Hooks[e?"on":"off"]("updateActor",O),D()}function O(e,t){const n=s("hpValue"),i=s("hpMax");return void 0!==n&&hasProperty(t,`system.${n}`)||void 0!==i&&hasProperty(t,`system.${i}`)?D():void 0}function I(e){l()||(game.user.isGM?D():Hooks.on("preUpdateToken",x))}function D(){w?.render()}function N(){w||(w=new MiniTracker,w.render(!0))}Hooks.once("init",(()=>{r({name:"enabled",scope:"client",config:!0,type:Boolean,default:!0,onChange:e=>{e?N():(w&&w.close(),w=null)}}),r({name:"scale",scope:"client",config:!0,type:Number,default:14,range:{min:10,max:30,step:2},onChange:D}),r({name:"hover",scope:"client",config:!0,type:Boolean,default:!0}),r({name:"delay",scope:"client",config:!0,type:Number,default:250}),r({name:"reversed",scope:"client",type:Boolean,default:!1}),r({name:"fake-reversed",scope:"client",type:Boolean,default:!1,onChange:D}),r({name:"coords",scope:"client",type:Object,default:{}}),r({name:"expanded",scope:"client",type:String,default:"false"}),r({name:"turn",config:!0,type:Boolean,default:!1,onChange:D}),r({name:"showHp",config:!0,type:String,default:"friendly",choices:["none","gm","friendly","all"],onChange:T}),r({name:"hpValue",config:!0,type:String,default:"attributes.hp.value",onChange:D}),r({name:"hpMax",config:!0,type:String,default:"attributes.hp.max",onChange:D}),r({name:"dim",config:!0,type:Boolean,default:!1,onChange:D}),r({name:"dead",config:!0,type:Boolean,default:!1,onChange:D}),r({name:"hide",config:!0,type:Boolean,default:!1}),r({name:"reveal",config:!0,type:Boolean,default:!1}),r({name:"revealToken",config:!0,type:Boolean,default:!0}),r({name:"immobilize",config:!0,type:Boolean,default:!1,onChange:I}),r({name:"pan",config:!0,type:Boolean,default:!0}),r({name:"select",config:!0,type:Boolean,default:!0}),r({name:"sheet",config:!0,type:Boolean,default:!1}),function(){const e=c("anonymous")?.api;e?(m=()=>!0,u=e.playersSeeName,g=e.toggleSeeName,f=e.getName):"pf2e"===game.system.id&&(m=h,u=e=>e.playersCanSeeName)}()})),Hooks.once("ready",(()=>{game.user.isGM&&(game.modules.get("_sortablejs")?.active||function(...e){const[t,n,i]=e;E(t,"error",n,i)}("sortable",!0)),setTimeout((()=>{s("enabled")&&N(),s("immobilize")&&I(),s("hpValue")&&T(!0)}),1e3)})),Hooks.on("renderCombatTrackerConfig",(function(e,t){!function(e){const t=s("dead")?"checked":"";let n='<div class="form-group">';n+=`<label>${p("settings.dead.name")}</label>`,n+=`<input type="checkbox" name="hideDeads" ${t}>`,n+=`<p class="notes">${p("settings.dead.hint")}</p>`,n+="</div>",e.find(".form-group").last().after(n)}(t),function(e){e.find('input[name="hideDeads"]').on("change",(function(){a("dead",$(this).is(":checked"))}))}(t),t.css("height","auto")}))})();
//# sourceMappingURL=main.js.map