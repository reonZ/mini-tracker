(()=>{"use strict";var e={d:(t,n)=>{for(var i in n)e.o(n,i)&&!e.o(t,i)&&Object.defineProperty(t,i,{enumerable:!0,get:n[i]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)};e.d({},{a:()=>x});let t="";function n(...e){return`${t}.settings.${e.join(".")}`}function i(...e){return e=e.filter((e=>"string"==typeof e)),`modules/${t}/templates/${e.join("/")}`}function o(e){return game.settings.get(t,e)}function s(e,n){return game.settings.set(t,e,n)}function a(e){const i=e.name;e.scope=e.scope??"world",e.config=e.config??!1,e.config&&(e.name=n(i,"name"),e.hint=n(i,"hint")),Array.isArray(e.choices)&&(e.choices=e.choices.reduce(((e,t)=>(e[t]=n(i,"choices",t),e)),{})),game.settings.register(t,i,e)}function r(e){return game.modules.get(e)}const d="monks-tokenbar";function c(){return r(d)?.active}function l(){return"pf2e"===game.system.id&&(game.settings.settings.has("pf2e.metagame.tokenSetsNameVisibility")?!!game.settings.get("pf2e","metagame.tokenSetsNameVisibility"):!!game.settings.get("pf2e","metagame_tokenSetsNameVisibility"))}let h,m,u,g;function f(...e){let[n,i]=e;return n=`${t}.${n}`,i?game.i18n.format(n,i):game.i18n.localize(n)}function p(e,n,i){return e.getFlag(t,n)??i}function b(){return h?.()??!1}function v(e){return e.actor?.hasPlayerOwner||(m?.(e)??!0)}function _(e){return u?.(e)}function y(e){return g?.(e)??f("unknown")}class MiniTracker extends Application{_isExpanded;_maxHeight;_dragging;_lastCombat;_lastCombatant;_lastMoveTime;_initialPosition;_initialPointer={x:0,y:0};_combatantHeight;_boxHeight;_innerMargins;_isReversed;_dragHook;_dragEndHook;_expandedDebounce;_coordsDebounce;_menu;_listHoverHook;_resizeHook;_resizeEndHook;_sortable;_hooks;_lastTurn;constructor(){super();const{left:e,bottom:t,top:n}=o("coords");"number"==typeof e&&(this.position.left=e),"number"==typeof n&&(this.position.top=n),"number"==typeof t&&(this.position.bottom=t);const i=o("expanded");this._isExpanded="false"!==i,this._maxHeight="false"!==i&&"true"!==i?parseInt(i):void 0,this._isReversed=o("reversed"),this._dragging=!1,this._lastCombat="",this._lastCombatant="",this._lastTurn=-1,this._lastMoveTime=0,this._dragHook=this.#e.bind(this),this._dragEndHook=this.#t.bind(this),this._resizeHook=this.#n.bind(this),this._resizeEndHook=this.#i.bind(this),this._hooks=[Hooks.on("renderCombatTracker",this.#o.bind(this)),Hooks.on("hoverToken",this.#s.bind(this)),Hooks.on("preCreateCombatant",this.#a.bind(this)),Hooks.on("targetToken",this.#o.bind(this))],this._coordsDebounce=debounce(this.#r,1e3),this._expandedDebounce=debounce(this.#d,1e3),this._initialPosition=this.position}static get defaultOptions(){return{...super.defaultOptions,popOut:!1,minimizable:!1,template:i("tracker.hbs")}}get isReversed(){return this._isReversed}set isReversed(e){this._isReversed=e,this.render(),s("reversed",e)}get isExpanded(){return this._isExpanded}set isExpanded(e){this._isExpanded=e,e?this.#c():this.#l(),this.#d()}get isDragging(){return this._dragging}set isDragging(e){this.element.toggleClass("dragging",e),this._dragging=e}get moveTick(){const e=Date.now();return!(e-this._lastMoveTime<1e3/60||(this._lastMoveTime=e,0))}get innerElement(){return this.element.find(".__inner")}get combatantElements(){return this.element.find(".combatant")}get listElement(){return this.element.find(".__inner > ol")}get combatantHeight(){return this._combatantHeight||(this._combatantHeight=this.combatantElements.filter(".active").outerHeight(!0)),this._combatantHeight}get boxHeight(){if(this._boxHeight)return this._boxHeight;const e=this.element.outerHeight(!0),t=this.listElement.innerHeight();return this._boxHeight=e-t,this._boxHeight}get innerMargins(){if(this._innerMargins)return this._innerMargins;const e=this.innerElement;return this._innerMargins=parseInt(e.css("margin-top"))+parseInt(e.css("margin-bottom")),this._innerMargins}get minHeight(){return this.combatantHeight+this.boxHeight}get maxHeight(){return this._maxHeight}set maxHeight(e){this._maxHeight=e,this._expandedDebounce()}async getData(e){const t=ui.combat.viewed;if(!t||!t.turns.some((e=>e.isOwner)))return{hasCombat:!1};const n=game.user.isGM,i=t.combatant,s=o("showHp"),a=o("hpValue"),r=o("hpMax"),d=o("turn"),l=this.isReversed,h=b(),m=o("immobilize")&&!c(),u=canvas.scene?.id,g=game.user.hasPermission("PING_CANVAS"),f=o("dead")&&game.settings.get("core","combatTrackerConfig").skipDefeated,_=o("dim");let H=!1,k=!1;const x=[];for(const[e,o]of t.turns.entries()){if(!o.visible)continue;if(f&&o.defeated&&!o.actor?.hasPlayerOwner)continue;let d=o.isDefeated;const c=new Map;if(o.actor)for(const e of o.actor.temporaryEffects)e.getFlag("core","statusId")===CONFIG.specialStatusEffects.DEFEATED?d=!0:e.icon&&c.set(e.icon,{icon:e.icon,name:e.label});const l=a?getProperty(o,`actor.system.${a}`):void 0,b=r?getProperty(o,`actor.system.${r}`):void 0;let E;void 0!==l&&void 0!==b&&(E=122*((C=l/b)*C)+3);const w=o.initiative,T=null!==w;T&&!Number.isInteger(w)&&(k=!0);const M=e===t.turn;M&&(H=!0);let D=o.name;const P=v(o),z=o.hidden,S=!!o.actor?.hasPlayerOwner,O=[];M&&O.push("active"),z&&O.push("hidden"),d&&O.push("defeated"),h&&!P&&(n?_&&O.push("anonymous"):D=y(o));const R={id:o.id,css:O.join(" "),name:D,img:await ui.combat._getCombatantThumbnail(o),hidden:z,hasPlayerOwner:S,playersCanSeeName:P,freed:!m||o===i||!!p(o,"freed"),canImmobilize:o!==i,defeated:d,canPing:g&&o.sceneId===u,effects:Array.from(c.values()),hasRolled:T,initiative:w,owner:o.isOwner,hpValue:l,hpMax:b,hpHue:E,active:M,targeted:o.token?.object.targeted.toObject().filter((e=>!e.isGM)).map((e=>e.color))??[],showHp:void 0!==l&&"none"!==s&&(n||"all"===s||"friendly"===s&&S)};x.push(R)}var C;if(!x.some((e=>e.owner)))return{hasCombat:!1};if(!H){const e=x[Math.min(t.turn??0,x.length-1)];e.active=!0;const n=e.css?e.css.split(" "):[];n.push("active"),e.css=n.join(" ")}const E=[];this.isExpanded&&E.push("expanded"),l&&!o("fake-reversed")&&E.push("reversed");const w=CONFIG.Combat.initiative.decimals;return x.forEach((e=>{null!==e.initiative&&(e.initiative=e.initiative.toFixed(k?w:0))})),{isGM:n,turns:x,endTurn:d,hideNames:h,immobilize:m,showHp:"all"===s||"friendly"===s||"gm"===s&&n,hasCombat:!0,round:t.round,arrow:l?"up":"down",innerCss:E.join(" "),isCurrentTurn:i?.isOwner,fontSize:o("scale")}}#o(){this.render()}async _render(e,t){var n;await super._render(e,t),game.user.isGM&&c()&&game.settings.get(d,"show-on-tracker")&&(n=this.listElement,ui.combat.element.find("#combat-tracker").find('.combatant:has([data-control="toggleMovement"])').each((function(){const e=$(this),t=e.attr("data-combatant-id"),i=e.find('[data-control="toggleMovement"]'),o=i.clone(!0);o.on("click",(()=>i.toggleClass("active"))),i.on("click",(()=>o.toggleClass("active"))),n.find(`[data-combatant-id="${t}"] [data-control="toggleDefeated"]`).before(o)})))}render(e,n){const i=ui.combat.viewed,s=game.user.isGM,a=i?.id??"",r=i?.combatant,d=o("immobilize")&&!c(),l=o("reveal"),h=o("revealToken"),m=this._lastCombatant!==r?.id,u=i?.turn!==this._lastTurn;if(s&&this._lastCombat===a&&r&&m&&u){const e=r?.token;if(e&&o("pan")&&r.visible&&canvas.animatePan({x:e.x,y:e.y}),r&&!r.actor?.hasPlayerOwner){e?.object&&o("select")&&e.object.control({releaseOthers:!0});const t=r.actor?.sheet;t&&o("sheet")&&t.render(!0)}}if(s&&i&&(this._lastCombat!==a||r&&m&&u)&&(d||l)){const e=`flags.${t}.${["freed"].join("/")}`,n=i.turns.reduce(((t,n,o)=>{let s=!1;const a={_id:n.id};return l&&o===i.turn&&n.hidden&&(h&&n.token?.update({hidden:!1}),a.hidden=!1,s=!0),d&&p(n,"freed")&&(a[e]=!1,s=!0),s&&t.push(a),t}),[]);n.length&&i.updateEmbeddedDocuments("Combatant",n)}return this._lastCombat=a,this._lastCombatant=r?.id??"",this._lastTurn=i?.turn??-1,super.render(e,n)}async close(e){const t=await super.close(e);return this._hooks.forEach((e=>Hooks.off("any",e))),t}activateListeners(e){if(!ui.combat.viewed||!this.innerElement.length)return;const t=ui.combat;e.find(".draggable").on("mousedown",this.#h.bind(this)),e.find(".__resizer").on("mousedown",this.#m.bind(this));const n=e.find(".__inner > ol");n.on("mouseenter",this.#u.bind(this)),e.on("mouseleave",this.#g.bind(this)),e.find("[data-control=trackerReverse]").on("click",(()=>this.isReversed=!this.isReversed)),e.find("[data-control=trackerExpand]").on("click",(()=>this.isExpanded=!this.isExpanded)),e.find("[data-control=targetCombatant]").on("click",this.#f.bind(this)),e.find(".combat-control").on("click",t._onCombatControl.bind(t)),e.find(".combatant-control").on("click",t._onCombatantControl.bind(t));const i=n.find(".combatant");i.on("mouseenter",t._onCombatantHoverIn.bind(t)),i.on("mouseleave",t._onCombatantHoverOut.bind(t)),game.user.isGM&&(this._contextMenu(e),this.#p(),e.find("[data-control=trackerSettings]").on("click",(()=>(new CombatTrackerConfig).render(!0))),c()||e.find('[data-control="toggleImmobilized"]').on("click",this.#b.bind(this)),b()&&u&&e.find("[data-control=toggle-name-visibility]").on("click",this.#v.bind(this)),i.on("click",t._onCombatantMouseDown.bind(t)))}setPosition({left:e,top:t,bottom:n}){const i=this.element[0],o=this.position,s=this.minHeight,a=i.offsetHeight,r=i.offsetWidth,d=window.innerHeight,c=window.innerWidth;e=e??c/2-r/2,t=t??d/2-a/2,n=n??d/2-a/2;const l=Math.max(c-r,0);return o.left=Math.clamped(e,0,l),i.style.left=o.left+"px",this.isReversed?(n+s>d&&(n=d-s),n<0&&(n=0),i.style.bottom=n+"px",o.bottom=n,o.top=d-n-s):(t+s>d&&(t=d-s),t<0&&(t=0),i.style.top=t+"px",o.top=t,o.bottom=d-t-s),this.#_(),o}_contextMenu(e){this._menu=ContextMenu.create(this,e,".combatant",ui.combat._getEntryContextOptions())}#a(e,t,n){n.temporary||!o("hide")||e.actor?.hasPlayerOwner||e.updateSource({hidden:!0})}#y(e){const t=$(e.currentTarget).closest(".combatant").attr("data-combatant-id");return ui.combat.viewed?.combatants.get(t)}#f(e){e.preventDefault();const t=this.#y(e),n=t?.token;if(!n)return;const i=Array.from(game.user.targets).map((e=>e.id)),o=e.shiftKey?i:i.filter((e=>e===n.id)),s=o.indexOf(n.id);-1!==s?o.splice(s,1):o.push(n.id),game.user.updateTokenTargets(o)}#b(e){e.preventDefault();const n=this.#y(e);n&&function(e){var n;n=!p(e,"freed"),e.setFlag(t,"freed",n)}(n)}async#v(e){e.preventDefault();const t=this.#y(e);t&&(e.shiftKey&&t.actor&&t.actor.isToken&&game.combat?.scene?function(e){return e.combat.turns.filter((t=>t.actorId===e.actorId))}(t).forEach(_):_(t))}#p(){game.modules.get("_sortablejs")?.active&&(this._sortable=new Sortable(this.listElement[0],{animation:150,draggable:".combatant",delay:50,onEnd:this.#H.bind(this)}))}#H(e){const t=e.item.dataset.combatantId,n=ui.combat.viewed,i=e.oldIndex,o=e.newIndex;if(!n||i===o||!t)return;const s=n.turns;if(s.length<=1)return;const a=s.filter((e=>e.id!==t)),r=a.slice(0,o),d=a.slice(o);let c=r.reverse().find((e=>null!=e.initiative))?.initiative,l=d.find((e=>null!=e.initiative))?.initiative;null==l&&null==c?(l=0,c=2):null==l?l=c-2:null==c&&(c=l+2);const h=(c+l)/2;n.setInitiative(t,h)}#m(e){e.preventDefault(),window.addEventListener("mousemove",this._resizeHook),window.addEventListener("mouseup",this._resizeEndHook)}#n(e){if(e.preventDefault(),!this.moveTick)return;let t=e.clientY-(this.position.top??0);this.isReversed&&(t=-(t-this.minHeight)),t=Math.max(t,this.minHeight),this.#_(t),t>=this.combatantElements.length*this.combatantHeight+this.boxHeight&&(t=void 0),this.maxHeight=t}#i(e){e.preventDefault(),window.removeEventListener("mousemove",this._resizeHook),window.removeEventListener("mouseup",this._resizeEndHook)}#h(e){e.preventDefault(),this.isDragging=!0,this._initialPosition=duplicate(this.position),this._initialPointer={x:e.clientX,y:e.clientY},window.addEventListener("mousemove",this._dragHook),window.addEventListener("mouseup",this._dragEndHook)}#e(e){if(e.preventDefault(),!this.moveTick)return;const t=this._initialPosition,n=this._initialPointer,i=(t.left??0)+(e.clientX-n.x);this.isReversed?this.setPosition({left:i,bottom:(t.bottom??0)-(e.clientY-n.y)}):this.setPosition({left:i,top:(t.top??0)+(e.clientY-n.y)}),this._coordsDebounce()}#t(e){e.preventDefault(),this.isDragging=!1,this.#_(),window.removeEventListener("mousemove",this._dragHook),window.removeEventListener("mouseup",this._dragEndHook)}#s(e,t){const n=e.combatant;if(!n)return;const i=this.combatantElements;i.removeClass("hovered"),t&&i.filter(`[data-combatant-id="${n.id}"]`).addClass("hovered")}#d(){s("expanded",this.isExpanded?this.maxHeight||"true":"false")}#c(){this.innerElement.addClass("expanded"),this.#_()}#l(){this._listHoverHook&&clearTimeout(this._listHoverHook),this.innerElement.removeClass("expanded"),this._menu?.close({animate:!1})}#u(){if(this.isExpanded||!o("hover"))return;const e=o("delay");e?this._listHoverHook=setTimeout((()=>this.#c()),e):this.#c()}#g(){this.isExpanded||this.#l()}#_(e){const t=this.innerElement;if(!t.length)return;const n=window.innerHeight;let i;i=this.isReversed?n-(this.position.bottom??0):n-(this.position.top??0),e&&e<i?i=e:this.maxHeight&&this.maxHeight<i&&(i=this.maxHeight),i=Math.max(i,this.minHeight),i-=this.innerMargins,t.css("max-height",i),this.isExpanded&&this.#k()}#k(){const e=this.listElement,t=e.innerHeight();if(t===e.prop("scrollHeight"))return;const n=e.find("> .active")[0];e.scrollTop(n.offsetTop-t/2+n.offsetHeight/2)}#r(){const{left:e,top:t,bottom:n}=this.position;s("coords",{left:e,top:t,bottom:n})}}function H(e,t,n,i){const o="string"==typeof t?t:"info",s="object"==typeof t?t:"object"==typeof n?n:void 0,a="boolean"==typeof t?t:"boolean"==typeof n?n:i??!1;ui.notifications.notify(f(e,s),o,{permanent:a})}function k(e,t){if(!x||!("x"in t)&&!("y"in t))return;const n=e.combatant,i=ui.combat.viewed;i&&n&&i.combatant!==n&&!p(n,"freed")&&(delete t.x,delete t.y,function(...e){const[t,n,i]=e;H(t,"warning",n,i)}("immobilized"))}t||(t="mini-tracker");let x=null;function C(e){Hooks[e?"on":"off"]("updateActor",E),T()}function E(e,t){const n=o("hpValue"),i=o("hpMax");return void 0!==n&&hasProperty(t,`system.${n}`)||void 0!==i&&hasProperty(t,`system.${i}`)?T():void 0}function w(e){c()||(game.user.isGM?T():Hooks.on("preUpdateToken",k))}function T(){x?.render()}function M(){x||(x=new MiniTracker,x.render(!0))}Hooks.once("init",(()=>{a({name:"enabled",scope:"client",config:!0,type:Boolean,default:!0,onChange:e=>{e?M():(x&&x.close(),x=null)}}),a({name:"scale",scope:"client",config:!0,type:Number,default:14,range:{min:10,max:30,step:2},onChange:T}),a({name:"hover",scope:"client",config:!0,type:Boolean,default:!0}),a({name:"delay",scope:"client",config:!0,type:Number,default:250}),a({name:"reversed",scope:"client",type:Boolean,default:!1}),a({name:"fake-reversed",scope:"client",type:Boolean,default:!1,onChange:T}),a({name:"coords",scope:"client",type:Object,default:{}}),a({name:"expanded",scope:"client",type:String,default:"false"}),a({name:"turn",config:!0,type:Boolean,default:!1,onChange:T}),a({name:"showHp",config:!0,type:String,default:"friendly",choices:["none","gm","friendly","all"],onChange:C}),a({name:"hpValue",config:!0,type:String,default:"attributes.hp.value",onChange:T}),a({name:"hpMax",config:!0,type:String,default:"attributes.hp.max",onChange:T}),a({name:"dim",config:!0,type:Boolean,default:!1,onChange:T}),a({name:"dead",config:!0,type:Boolean,default:!1,onChange:T}),a({name:"hide",config:!0,type:Boolean,default:!1}),a({name:"reveal",config:!0,type:Boolean,default:!1}),a({name:"revealToken",config:!0,type:Boolean,default:!0}),a({name:"immobilize",config:!0,type:Boolean,default:!1,onChange:w}),a({name:"pan",config:!0,type:Boolean,default:!0}),a({name:"select",config:!0,type:Boolean,default:!0}),a({name:"sheet",config:!0,type:Boolean,default:!1}),function(){const e=r("anonymous")?.api;e?(h=()=>!0,m=e.playersSeeName,u=e.toggleSeeName,g=e.getName):"pf2e"===game.system.id&&(h=l,m=e=>e.playersCanSeeName)}()})),Hooks.once("ready",(()=>{game.user.isGM&&(game.modules.get("_sortablejs")?.active||function(...e){const[t,n,i]=e;H(t,"error",n,i)}("sortable",!0)),setTimeout((()=>{o("enabled")&&M(),o("immobilize")&&w(),o("hpValue")&&C(!0)}),1e3)})),Hooks.on("renderCombatTrackerConfig",(function(e,t){!function(e){const t=o("dead")?"checked":"";let n='<div class="form-group">';n+=`<label>${f("settings.dead.name")}</label>`,n+=`<input type="checkbox" name="hideDeads" ${t}>`,n+=`<p class="notes">${f("settings.dead.hint")}</p>`,n+="</div>",e.find(".form-group").last().after(n)}(t),function(e){e.find('input[name="hideDeads"]').on("change",(function(){s("dead",$(this).is(":checked"))}))}(t),t.css("height","auto")}))})();
//# sourceMappingURL=main.js.map